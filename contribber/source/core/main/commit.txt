Fixed logic bug causing wrong results
Refactored code to reduce code duplication
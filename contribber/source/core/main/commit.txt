Fixed logic bug causing incorrect results
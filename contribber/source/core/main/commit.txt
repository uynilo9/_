Fixed bug causing memory leak